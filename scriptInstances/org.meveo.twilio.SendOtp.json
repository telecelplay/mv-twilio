{
  "code" : "org.meveo.twilio.SendOtp",
  "description" : "Send Otp code by SMS",
  "inputs" : [ {
    "name" : "to",
    "type" : "String"
  } ],
  "outputs" : [ {
    "name" : "result",
    "type" : "String"
  } ],
  "generateOutputs" : false,
  "type" : "JAVA",
  "transactionType" : "SAME",
  "script" : "package org.meveo.twilio;\n\nimport java.util.Map;\nimport java.util.List;\nimport java.util.HashMap;\nimport java.util.Random;\nimport java.time.Instant;\nimport java.time.Duration;\nimport org.meveo.service.script.Script;\nimport org.meveo.model.customEntities.OutboundSMS;\nimport org.meveo.admin.exception.BusinessException;\nimport org.slf4j.LoggerFactory;\nimport org.json.*;\nimport javax.ws.rs.client.*;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport javax.ws.rs.core.*;\nimport org.meveo.model.customEntities.Credential;\nimport org.meveo.service.storage.RepositoryService;\nimport org.meveo.model.storage.Repository;\nimport org.meveo.api.persistence.CrossStorageApi;\nimport org.meveo.model.persistence.CEIUtils;\nimport org.meveo.credentials.CredentialHelperService;\n\npublic class SendOtp extends Script {\n\n    private String to;\n\n    private String result;\n\n    public String getResult() {\n        return result;\n    }\n\n    private static final Logger log = LoggerFactory.getLogger(SendOtp.class);\n    private static final String TWILIO_URL = \"api.twilio.com\";\n    private static final Duration MIN_DURATION = Duration.ofSeconds(30);\n    private static final int MAX_MESSAGE_IN_DAY = 5;\n\n    private CrossStorageApi crossStorageApi = getCDIBean(CrossStorageApi.class);\n    private RepositoryService repositoryService = getCDIBean(RepositoryService.class);\n    private Repository defaultRepo = repositoryService.findDefaultRepository();\n\n    @Override\n    public void execute(Map<String, Object> parameters) throws BusinessException {\n        List<OutboundSMS> lastSMSList = crossStorageApi.find(defaultRepo, OutboundSMS.class)\n                .by(\"to\", to)\n                .by(\"purpose\", \"OTP\")\n                .by(\"fromRange creationDate\", Instant.now())\n                .orderBy(\"creationDate\", false) // order by descending creation date to retriev the\n                                                // newest one\n                .getResults();\n\n        if (lastSMSList != null && lastSMSList.size() > 0) {\n            OutboundSMS lastSMS = lastSMSList.get(0);\n            Duration duration = Duration.between(lastSMS.getCreationDate(), Instant.now());\n            if (duration.compareTo(MIN_DURATION) < 0) {\n                // throw new BusinessException(\"There is an ogoing Otp, please wait.\");\n                result = \"retry_later\";\n                return;\n            }\n            if (lastSMSList.size() >= MAX_MESSAGE_IN_DAY) {\n                result = \"too_many_requests\";\n                return;\n            }\n        }\n        Credential credential =\n                CredentialHelperService.getCredential(TWILIO_URL, crossStorageApi, defaultRepo);\n        if (credential == null) {\n            // throw new BusinessException(\"No credential found for \"+TWILIO_URL);\n            log.error(\"No credential found for \" + TWILIO_URL);\n            result = \"server_error\";\n            return;\n        } else {\n            log.info(\"using credential {} with username {}\", credential.getUuid(),\n                    credential.getUsername());\n        }\n        String TWILIO_SID = credential.getUsername();\n        String TWILIO_MESSAGE_ID = credential.getToken();\n        String from = credential.getRefreshToken();\n        String url = \"https://api.twilio.com/2010-04-01/Accounts/\" + TWILIO_SID + \"/Messages.json\";\n        Random rnd = new Random();\n        String otp = String.format(\"%06d\", rnd.nextInt(999999));\n        String message = \"Your telecelplay verification code is:\" + otp;\n        Form map = new Form().param(\"To\", to).param(\"MessagingServiceSid\", TWILIO_MESSAGE_ID)\n                .param(\"Body\", message).param(\"From\", from);\n        Client client = ClientBuilder.newClient();\n        WebTarget target = client.target(url);\n        OutboundSMS record = new OutboundSMS();\n        Response response = null;\n        try {\n            response = CredentialHelperService.setCredential(target.request(), credential)\n                    .post(Entity.form(map), Response.class);\n            log.info(\"Response : {}\", response);\n        } catch (Exception ex) {\n            log.error(\"error while hitting  twilio url :{}\", ex.getMessage());\n            // throw new BusinessException(\"Something went wrong.Please try after sometime\");\n            result = \"server_error\";\n            return;\n        }\n        String value = response.readEntity(String.class);\n        JSONObject json = new JSONObject(value);\n        result = json.getString(\"status\");\n        if (\"accepted\".equalsIgnoreCase(result)) {\n            log.info(\"Value : {}\", value);\n            record.setCreationDate(Instant.now());\n            record.setPurpose(\"OTP\");\n            record.setOtpCode(otp);\n            record.setTo(to);\n            record.setMessage(message);\n            record.setResponse(result);\n            try {\n                crossStorageApi.createOrUpdate(defaultRepo, record);\n            } catch (Exception ex) {\n                log.error(\"error updating twilio record :{}\", ex.getMessage());\n                result = \"server_error\";\n            }\n        }\n    }\n\n    public void setTo(String to) {\n        this.to = to;\n    }\n}\n",
  "executionRoles" : [ ],
  "sourcingRoles" : [ ],
  "mavenDependencies" : [ {
    "groupId" : "com.twilio.sdk",
    "artifactId" : "twilio",
    "version" : "8.27.0",
    "coordinates" : "com.twilio.sdk:twilio:8.27.0"
  } ],
  "importScriptInstances" : [ {
    "code" : "org.meveo.credentials.CredentialHelperService",
    "description" : "Helper function to build request with credentials",
    "inputs" : [ ],
    "outputs" : [ ],
    "generateOutputs" : false,
    "type" : "JAVA",
    "transactionType" : "SAME",
    "script" : "package org.meveo.credentials;\n\nimport java.util.Map;\n\nimport org.meveo.service.script.Script;\nimport org.meveo.admin.exception.BusinessException;\nimport javax.ws.rs.client.*;\n\nimport java.io.IOException;\nimport java.util.List;\nimport org.meveo.model.customEntities.Credential;\nimport org.meveo.model.storage.Repository;\nimport org.meveo.api.persistence.CrossStorageApi;\nimport org.meveo.elresolver.ValueExpressionWrapper;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\npublic class CredentialHelperService extends Script {\n\n  private static final Logger log = LoggerFactory.getLogger(CredentialHelperService.class);\n\n  public static class LoggingFilter implements ClientRequestFilter {\n    @Override\n    public void filter(ClientRequestContext requestContext) throws IOException {\n      if (requestContext != null) {\n        if (requestContext.getEntity() != null) {\n          log.info(requestContext.getEntity().toString());\n        } else {\n          log.info(\"uri:{}\", requestContext.getUri());\n        }\n      }\n    }\n  }\n\n  public static Credential getCredential(String domain, CrossStorageApi crossStorageApiInstance,\n      Repository repo) {\n    List<Credential> matchigCredentials = crossStorageApiInstance.find(repo, Credential.class)\n        .by(\"domainName\", domain)\n        .getResults();\n    if (matchigCredentials.size() > 0) {\n      return matchigCredentials.get(0);\n    } else {\n      return null;\n    }\n  }\n\n  public static Invocation.Builder setCredential(Invocation.Builder invocBuilder,\n      Credential credential) throws BusinessException {\n    String headerKey = credential.getHeaderKey();\n    String headerValue = credential.getHeaderValue();\n    try {\n      if (headerKey != null && headerKey.contains(\"#{\")) {\n        headerKey =\n            ValueExpressionWrapper.evaluateToStringMultiVariable(headerKey, \"entity\", credential);\n      }\n      if (headerValue != null && headerValue.contains(\"#{\")) {\n        headerValue =\n            ValueExpressionWrapper.evaluateToStringMultiVariable(headerValue, \"entity\", credential);\n      }\n    } catch (Exception e) {\n      throw new BusinessException(e);\n    }\n    return invocBuilder.header(headerKey, headerValue);\n  }\n\n  @Override\n  public void execute(Map<String, Object> parameters) throws BusinessException {}\n\n}\n",
    "executionRoles" : [ ],
    "sourcingRoles" : [ ],
    "mavenDependencies" : [ ],
    "importScriptInstances" : [ ]
  } ]
}