{"code":"org.meveo.twilio.SendSMS","inputs":[{"name":"to","type":"","description":"to"}],"outputs":[{"name":"result","type":"String"}],"generateOutputs":false,"type":"JAVA","transactionType":"SAME","script":"package org.meveo.twilio;\r\n\r\nimport java.util.Map;\r\nimport java.util.HashMap;\r\nimport java.util.Random;\r\nimport org.meveo.service.script.Script;\r\nimport org.meveo.model.customEntities.OutboundSMS;\r\nimport org.meveo.admin.exception.BusinessException;\r\nimport org.slf4j.LoggerFactory;\r\nimport org.json.*;\r\nimport javax.ws.rs.client.*;\r\nimport org.slf4j.Logger;\r\nimport org.slf4j.LoggerFactory;\r\nimport javax.ws.rs.core.*;\r\nimport org.meveo.service.storage.RepositoryService;\r\nimport org.meveo.model.storage.Repository;\r\nimport org.meveo.api.persistence.CrossStorageApi;\r\nimport org.meveo.model.persistence.CEIUtils;\r\nimport org.glassfish.jersey.client.authentication.HttpAuthenticationFeature;\r\n\r\npublic class SendSMS extends Script {\r\n\r\n    private String to;\r\n\r\n    private String result;\r\n\r\n    public String getResult() {\r\n        return result;\r\n    }\r\n\r\n    private static final Logger log = LoggerFactory.getLogger(SendSMS.class);\r\n\r\n    private CrossStorageApi crossStorageApi = getCDIBean(CrossStorageApi.class);\r\n\r\n    private RepositoryService repositoryService = getCDIBean(RepositoryService.class);\r\n\r\n    private Repository defaultRepo = repositoryService.findDefaultRepository();\r\n\r\n    @Override\r\n    public void execute(Map<String, Object> parameters) throws BusinessException {\r\n        String TWILIO_SID = \"AC76212344a90c381e1167b4a1d190af36\";\r\n        String TWILIO_API_KEY = \"52a357f6d47ecd115a493ab15e5ab778\";\r\n        String url = \"https://api.twilio.com/2010-04-01/Accounts/AC76212344a90c381e1167b4a1d190af36/Messages.json\";\r\n        Random rnd = new Random();\r\n        int number = rnd.nextInt(999999);\r\n        String message = Integer.toString(number);\r\n        Form map = new Form().param(\"To\", to).param(\"MessagingServiceSid\", \"MG2b8962bf2b0f196d3ba43919fcf98bac\").param(\"Body\", message).param(\"From\", \"+17604927786\");\r\n        HttpAuthenticationFeature feature = HttpAuthenticationFeature.basicBuilder().nonPreemptive().credentials(TWILIO_SID, TWILIO_API_KEY).build();\r\n        Client client = ClientBuilder.newClient();\r\n        client.register(feature);\r\n        WebTarget target = client.target(url);\r\n        OutboundSMS record = new OutboundSMS();\r\n        Response response = null;\r\n      try{\r\n        response = target.request().post(Entity.form(map), Response.class);\r\n       \r\n      }catch(Exception ex){\r\n        log.error(\"error while hitting  twilio url :{}\", ex.getMessage());\r\n        throw new BusinessException(\"Something went wrong.Please try after sometime\");\r\n         \r\n        \r\n      }\r\n      String value = response.readEntity(String.class);\r\n      log.info(\"Response : {}\", response);\r\n        JSONObject json = new JSONObject(value);\r\n      \r\n        result = json.getString(\"status\");\r\n        record.setTo(to);\r\n        record.setMessage(message);\r\n        record.setResponse(result);\r\n        try {\r\n            crossStorageApi.createOrUpdate(defaultRepo, record);\r\n        } catch (Exception ex) {\r\n            log.error(\"error updating twilio record :{}\", ex.getMessage());\r\n        }\r\n        super.execute(parameters);\r\n    }\r\n}\r\n","executionRoles":[],"sourcingRoles":[],"mavenDependencies":[{"groupId":"org.glassfish.jersey.bundles","artifactId":"jaxrs-ri","version":"2.17","coordinates":"org.glassfish.jersey.bundles:jaxrs-ri:2.17"}],"importScriptInstances":[]}